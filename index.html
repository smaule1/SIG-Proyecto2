<!DOCTYPE html>
<html>
<header>
    <meta charset="utf-8" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script src="cantones_tumores_var.js" type="text/javascript"></script>
    <script src="cantones_tumores_pulm_var.js" type="text/javascript"></script>
    
    <script src="./Clinicas/clinicas_selec_ganglio_var.js" type="text/javascript"></script>
    <script src="./Hospitales/hospitales_selec_ganglios_var.js" type="text/javascript"></script>
    
    
    <link rel="stylesheet" href="style.css">

    <style>
        .layer-selector {
            background: white;
            padding: 8px 10px;
            border-radius: 4px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        .layer-selector label {
            font-size: 13px;
        }
    </style>
</header>

<body>
    <div id="map" style="height:100vh; width:100%;"></div>

    <script>
        // =====================================================================
        // MAPA
        // =====================================================================
        var map = L.map('map').setView([9.928, -84.026], 8);

        // Datos de cantones
        var dataGanglios = data;        
        var dataPulmon   = data_pulm;   

        // Tipo inicial
        var currentTipo = 'ganglios';

        // Capas GeoJSON
        var geojsonGanglios = null;
        var geojsonPulmon   = null;

        // Capas de puntos (clínicas y hospitales)
        var clinicasGangliosLayer   = null;
        var clinicasPulmonLayer     = null;
        var hospitalesGangliosLayer = null;

        // =====================================================================
        // ESTILOS
        // =====================================================================
        function getColor(num) {
            return  num > 25 ? '#a63603' :
                    num > 20 ? '#e6550d' :
                    num > 15 ? '#fd8d3c' :
                    num > 10 ? '#fdae6b' :
                    num > 5  ? '#fdd0a2' :
                               '#feedde';
        }

        function getTasa(props) {
            if (currentTipo === 'ganglios') {
                return props.GANGLIOS_TASA;
            } else {
                return props.PULMONES_TASA;
            }
        }

        function style(feature) {
            var tasa = getTasa(feature.properties);
            return {
                fillColor: getColor(tasa),
                fillOpacity: 1,
                opacity: 1,
                color: 'black',
                weight: 1
            };
        }

        // =====================================================================
        // CONTROLES DE INFO Y LEYENDA
        // =====================================================================
        var info = L.control();
        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };

        function getTituloInfo() {
            return (currentTipo === 'ganglios')
                ? 'Tasa de Cáncer de Ganglios'
                : 'Tasa de Cáncer de Pulmón';
        }

        info.update = function (props) {
            this._div.innerHTML = '<h4>' + getTituloInfo() + '</h4>' +  (props ?
                '<b>' + props.NCANTON + '</b><br />' +
                getTasa(props) + ' por 100 000 habitantes'
                : 'Coloque el cursor sobre un cantón');
        };

        info.addTo(map);

        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend'),
                grades = [0, 5, 10, 15, 20, 25];

            for (var i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                    grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
            }
            return div;
        };
        legend.addTo(map);

        // =====================================================================
        // INTERACCIONES
        // =====================================================================
        function highlightFeature(e) {
            var layer = e.target;
            info.update(layer.feature.properties);
        }

        function resetHighlight(e) {
            info.update();
        }

        function zoomToFeature(e) {
            map.fitBounds(e.target.getBounds());
        }

        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: zoomToFeature
            });
        }

        // =====================================================================
        // FUNCIONES PARA CREAR CAPAS
        // =====================================================================
        function createGangliosLayer() {
            return L.geoJson(dataGanglios, {
                style: style,
                onEachFeature: onEachFeature
            });
        }

        function createPulmonLayer() {
            if (typeof dataPulmon === 'undefined' || !dataPulmon) {
                console.error('dataPulmon is not defined. Make sure cantones_tumores_pulm_var.js is loaded.');
                return L.layerGroup();
            }
            return L.geoJson(dataPulmon, {
                style: style,
                onEachFeature: onEachFeature
            });
        }

        function clinicaMarker(geoJsonPoint, latlng) {
            var icon = L.icon({
                iconUrl: "./Clinicas/clinica_icon.png",
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });
            return L.marker(latlng, {
                icon: icon,
                title: geoJsonPoint.properties.NOMBRE,
                riseOnHover: true
            });
        }

        function hospitalMarker(geoJsonPoint, latlng) {
            var icon = L.icon({
                iconUrl: "./Hospitales/hospital_icon.png",
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });
            return L.marker(latlng, {
                icon: icon,
                title: geoJsonPoint.properties.NOMBRE,
                riseOnHover: true
            });
        }

        function createClinicasGangliosLayer() {
            return L.geoJson(clinicasGanglios, { pointToLayer: clinicaMarker });
        }

        function createClinicasPulmonLayer() {
            // Crear un grupo de capas para las clínicas de pulmón
            var clinicasPulmonGroup = L.layerGroup();
            
            // Icono para las clínicas
            var clinicaIcon = L.icon({
                iconUrl: "./Clinicas/clinica_icon.png",
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });
            
            // Agregar manualmente cada clínica de pulmón
            // Coordenadas: [longitud, latitud] -> L.marker usa [latitud, longitud]
            var clinicasPulmonData = [
                { nombre: "CLINICA COLORADO ABANGARES", lat: 10.184359318428777, lng: -85.109637243902768 },
                { nombre: "EBAIS LAS JUNTAS DE ABANGARES", lat: 10.280217654303094, lng: -84.958952819735373 },
                { nombre: "CLINICA LAS JUNTAS", lat: 10.280171438467487, lng: -84.958971767842868 },
                { nombre: "CLINICA ABANGARES", lat: 10.262373944005139, lng: -84.945757748649342 },
                { nombre: "EBAIS ABANGARES", lat: 10.262373944005139, lng: -84.945757748649342 },
                { nombre: "EBAIS HOJANCHA", lat: 10.057706963958443, lng: -85.417189863211036 },
                { nombre: "CLINICA HOJANCHA", lat: 10.057706963958443, lng: -85.417189863211036 },
                { nombre: "CLINICA NANDAYURE", lat: 9.996375174935581, lng: -85.253200704916154 },
                { nombre: "CLINICA MIRAMAR", lat: 10.091696112850062, lng: -84.728564456234125 },
                { nombre: "CLINICA MEDICA NAZARET", lat: 10.05642799411836, lng: -84.728596754962695 },
                { nombre: "CLINICA DE TURRUBARES", lat: 9.909121278268337, lng: -84.440755973747088 },
                { nombre: "CLINICA SAN PABLO DE TURRUBARES", lat: 9.909121278268337, lng: -84.440755973747088 }
            ];
            
            // Crear y agregar cada marcador al grupo
            clinicasPulmonData.forEach(function(clinica) {
                var marker = L.marker([clinica.lat, clinica.lng], {
                    icon: clinicaIcon,
                    title: clinica.nombre,
                    riseOnHover: true
                });
                clinicasPulmonGroup.addLayer(marker);
            });
            
            return clinicasPulmonGroup;
        }

        function createHospitalesGangliosLayer() {
            return L.geoJson(hospitalesGanglios, { pointToLayer: hospitalMarker });
        }

        // =====================================================================
        // CAPAS INICIALES (GANGLIOS)
        // =====================================================================
        geojsonGanglios = createGangliosLayer().addTo(map);
        clinicasGangliosLayer   = createClinicasGangliosLayer().addTo(map);
        hospitalesGangliosLayer = createHospitalesGangliosLayer().addTo(map);

        // =====================================================================
        // CONTROL PARA CAMBIAR ENTRE GANGLIOS / PULMÓN
        // =====================================================================
        var layerSelector = L.control({position: 'topright'});
        layerSelector.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'layer-selector');
            div.innerHTML =
                '<strong>Tipo de tumor</strong><br>' +
                '<label><input type="radio" name="tumorLayer" value="ganglios" checked> Ganglios</label><br>' +
                '<label><input type="radio" name="tumorLayer" value="pulmon"> Pulmón</label>';

            L.DomEvent.disableClickPropagation(div);
            return div;
        };
        layerSelector.addTo(map);

        function switchLayer(tipo) {
            currentTipo = tipo;

            // Quitar todas las capas actuales
            if (geojsonGanglios && map.hasLayer(geojsonGanglios)) {
                map.removeLayer(geojsonGanglios);
            }
            if (geojsonPulmon && map.hasLayer(geojsonPulmon)) {
                map.removeLayer(geojsonPulmon);
            }
            if (clinicasGangliosLayer && map.hasLayer(clinicasGangliosLayer)) {
                map.removeLayer(clinicasGangliosLayer);
            }
            if (clinicasPulmonLayer && map.hasLayer(clinicasPulmonLayer)) {
                map.removeLayer(clinicasPulmonLayer);
            }
            if (hospitalesGangliosLayer && map.hasLayer(hospitalesGangliosLayer)) {
                map.removeLayer(hospitalesGangliosLayer);
            }

            // Agregar capas según el tipo seleccionado
            if (tipo === 'ganglios') {
                geojsonGanglios = createGangliosLayer().addTo(map);
                clinicasGangliosLayer   = createClinicasGangliosLayer().addTo(map);
                hospitalesGangliosLayer = createHospitalesGangliosLayer().addTo(map);
            } else {
                geojsonPulmon = createPulmonLayer().addTo(map);
                clinicasPulmonLayer = createClinicasPulmonLayer().addTo(map);
            }

            info.update();
        }

        document.addEventListener('change', function(e) {
            if (e.target && e.target.name === 'tumorLayer') {
                switchLayer(e.target.value);
            }
        });
    </script>
</body>
</html>
